@using SleepyTimeSoaps.Models;
@model SleepyTimeSoaps.Models.CheckoutModel


@{
    ViewBag.Title = "Market Checkout";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<script type="text/javascript" src="https://js.squareup.com/v2/paymentform">
</script>

<script type="text/javascript" src="~/Scripts/sq-payment-form.js"></script>

<script src="https://code.jquery.com/jquery-1.10.0.min.js"
        integrity="sha256-2+LznWeWgL7AJ1ciaIG5rFP7GKemzzl+K75tRyTByOE="
        crossorigin="anonymous">
</script>

<link rel="stylesheet" href="~/Content/sq-payment-form.css" />

<div class="bg-dark w-100" style="border-radius: 20px;">
    <div class="bg-image hover-overlay ripple shadow-1-strong rounded m-4" style="padding-top: 20px;"
         data-mdb-ripple-color="light">
        <div class="row">
            <div class="col-md-4 order-md-2 mb-4">
                <h4 class="d-flex justify-content-between align-items-center mb-3">
                    <span class="text-white">Your bag</span>
                    <span class="badge badge-secondary badge-pill">@Model.Products.Count</span>
                </h4>
                <ul class="list-group mb-3">
                    @foreach (Product p in Model.Products)
                    {
                        <li class="list-group-item d-flex justify-content-between lh-condensed">
                            <div>
                                <h6 class="my-0">@p.ProductName <small>x@(p.Quantity)</small></h6>
                                <small class="text-muted">@(p.Naked ? "Naked" : "Wrapped")</small>
                                @if (p.SelectedAttributes.Count > 1)
                                {
                                    foreach (string s in p.SelectedAttributes)
                                    {
                                        <br />
                                        <small class="text-muted">@s</small>
                                    }
                                }
                            </div>
                            <span>@p.FinalProductPrice.ToString("c")</span>
                        </li>
                    }
                    @if (Model.DiscountApplied)
                    {
                        <li class="list-group-item d-flex justify-content-between lh-condensed" style="background-color: #a7fe84">
                            <div>
                                <h6 class="my-0">Promo / Discount</h6>

                                <small>@Model.DiscountName</small>
                            </div>
                            <span>-@Model.DiscountPercentage%</span>
                        </li>
                    }
                    @if (Model.ShippingSubtotal() == 0)
                    {
                        <li class="list-group-item d-flex justify-content-between lh-condensed" style="background-color: #a7fe84">
                            <div>
                                <h6 class="my-0">Site Pickup</h6>

                                <small>@Model.ShippingNote</small>
                            </div>
                            <span>FREE</span>
                        </li>
                    }
                    else
                    {
                        <li class="list-group-item d-flex justify-content-between lh-condensed" style="background-color: #c6c6c6">
                            <div>
                                <h6 class="my-0">Shipping</h6>
                                <small>@Model.ShippingNote</small>
                            </div>
                            <span>@Model.ShippingSubtotal().ToString("c")</span>
                        </li>
                    }
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Total (USD)</span>
                        <strong>@Model.CartTotal.ToString("c")</strong>
                    </li>
                </ul>

                @using (Html.BeginForm("SubmitDiscountCode", "Checkout"))
                {
                    @Html.HiddenFor(m => m.OrderID)
                    @Html.HiddenFor(m => m._Model)

                    <div class="card p-2">
                        <div class="input-group">
                            <input type="text" class="form-control" name="code" placeholder="Promo code">
                            <div class="input-group-append">
                                <button type="submit" class="btn btn-secondary">Redeem</button>
                            </div>
                        </div>
                    </div>
                }
            </div>
            <div class="col-md-8 order-md-1 text-white">
                @using (Html.BeginForm("UpdateMarketContact", "Checkout"))
                {
                    <h4 class="mb-3">Order Info</h4>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="firstName">First name</label>
                            <input type="text" class="form-control" id="firstname" name="firstname" placeholder="" value="@Model.firstname" required="" style="background-image: url(&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABHklEQVQ4EaVTO26DQBD1ohQWaS2lg9JybZ+AK7hNwx2oIoVf4UPQ0Lj1FdKktevIpel8AKNUkDcWMxpgSaIEaTVv3sx7uztiTdu2s/98DywOw3Dued4Who/M2aIx5lZV1aEsy0+qiwHELyi+Ytl0PQ69SxAxkWIA4RMRTdNsKE59juMcuZd6xIAFeZ6fGCdJ8kY4y7KAuTRNGd7jyEBXsdOPE3a0QGPsniOnnYMO67LgSQN9T41F2QGrQRRFCwyzoIF2qyBuKKbcOgPXdVeY9rMWgNsjf9ccYesJhk3f5dYT1HX9gR0LLQR30TnjkUEcx2uIuS4RnI+aj6sJR0AM8AaumPaM/rRehyWhXqbFAA9kh3/8/NvHxAYGAsZ/il8IalkCLBfNVAAAAABJRU5ErkJggg==&quot;); background-repeat: no-repeat; background-attachment: scroll; background-size: 16px 18px; background-position: 98% 50%;">
                            <div class="invalid-feedback">
                                Valid first name is required.
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="lastName">Last name</label>
                            <input type="text" class="form-control" id="lastname" name="lastname" placeholder="" value="@Model.lastname" required="">
                            <div class="invalid-feedback">
                                Valid last name is required.
                            </div>
                        </div>
                    </div>

                    {
                        var user = Membership.GetUser(System.Web.HttpContext.Current.User.Identity.Name);
                        string email = string.Empty;

                        if (user != null)
                        {
                            email = user.Email;
                            <div class="mb-3">
                                <label for="email">Email <span class="text-muted">(Optional)</span></label>
                                <input type="email" class="form-control" id="email" placeholder="you@example.com" value="@email">
                                <div class="invalid-feedback">
                                    Please enter a valid email address for order updates.
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="mb-3">
                                <label for="email">Email <span class="text-muted">(Optional)</span></label>
                                <input type="email" class="form-control" id="email" name="email" placeholder="you@example.com">
                                <div class="invalid-feedback">
                                    Please enter a valid email address for order updates.
                                </div>
                            </div>
                        }
                    }

                    @Html.HiddenFor(m => m.OrderID)
                    @Html.HiddenFor(m => m._Model)

                    <div class="row">
                        <div class="col">
                            <input type="submit" class="btn mb-3 w-100 btn-primary" value="Update Contact Information" />
                        </div>
                    </div>
                }

                @if (!string.IsNullOrWhiteSpace(Model.ShippingInfo))
                {
                    <div class="float-left w-50">
                        <hr class="mb-4 border-white">

                        <h4 class="mb-3">Payment</h4>


                        <!-- Begin Payment Form -->
                        <div class="sq-payment-form">
                            <!--
                              Square's JS will automatically hide these buttons if they are unsupported
                              by the current device.
                            -->
                            <div id="sq-walletbox">
                                @using (Html.BeginForm("CashCheckout", "Checkout", FormMethod.Post))
                                {
                                    @Html.HiddenFor(m => m._Model)
                                    @Html.HiddenFor(m => m.OrderID)

                                    <button type="submit" id="cash" class="button-cash btn-success active">
                                        Buy with cash&nbsp;&nbsp;&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cash-coin" viewBox="0 0 16 16">
                                            <path fill-rule="evenodd" d="M11 15a4 4 0 1 0 0-8 4 4 0 0 0 0 8zm5-4a5 5 0 1 1-10 0 5 5 0 0 1 10 0z"></path>
                                            <path d="M9.438 11.944c.047.596.518 1.06 1.363 1.116v.44h.375v-.443c.875-.061 1.386-.529 1.386-1.207 0-.618-.39-.936-1.09-1.1l-.296-.07v-1.2c.376.043.614.248.671.532h.658c-.047-.575-.54-1.024-1.329-1.073V8.5h-.375v.45c-.747.073-1.255.522-1.255 1.158 0 .562.378.92 1.007 1.066l.248.061v1.272c-.384-.058-.639-.27-.696-.563h-.668zm1.36-1.354c-.369-.085-.569-.26-.569-.522 0-.294.216-.514.572-.578v1.1h-.003zm.432.746c.449.104.655.272.655.569 0 .339-.257.571-.709.614v-1.195l.054.012z"></path>
                                            <path d="M1 0a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h4.083c.058-.344.145-.678.258-1H3a2 2 0 0 0-2-2V3a2 2 0 0 0 2-2h10a2 2 0 0 0 2 2v3.528c.38.34.717.728 1 1.154V1a1 1 0 0 0-1-1H1z"></path>
                                            <path d="M9.998 5.083 10 5a2 2 0 1 0-3.132 1.65 5.982 5.982 0 0 1 3.13-1.567z"></path>
                                        </svg>
                                    </button>
                                }
                                <button id="sq-google-pay" class="button-google-pay"></button>
                                <button id="sq-apple-pay" class="sq-apple-pay"></button>
                                <button id="sq-masterpass" class="sq-masterpass"></button>
                                <div class="sq-wallet-divider">
                                    <span class="sq-wallet-divider__text">Or</span>
                                </div>
                            </div>
                            <div id="sq-ccbox">
                                <!--
                                  You should replace the action attribute of the form with the path of
                                  the URL you want to POST the nonce to (for example, "/process-card").
                                  You need to then make a "Charge" request to Square's transaction API with
                                  this nonce to securely charge the customer.
                                  Learn more about how to setup the server component of the payment form here:
                                  https://docs.connect.squareup.com/payments/transactions/processing-payment-rest
                                -->
                                @using (Html.BeginForm("SubmitPayment", "Checkout", FormMethod.Post, new { id = "nonce-form" }))
                                {
                                    @Html.HiddenFor(m => m.OrderID)
                                    @Html.HiddenFor(m => m.CartTotal)
                                    @Html.HiddenFor(m => m.ShippingInfo)
                                    @Html.HiddenFor(m => m._Model)

                                    <div class="sq-field">
                                        <label class="sq-label text-white">Card Number</label>
                                        <div id="sq-card-number"></div>
                                    </div>
                                    <div class="sq-field-wrapper">
                                        <div class="sq-field sq-field--in-wrapper">
                                            <label class="sq-label text-white">CVV</label>
                                            <div id="sq-cvv"></div>
                                        </div>
                                        <div class="sq-field sq-field--in-wrapper">
                                            <label class="sq-label text-white">Expiration</label>
                                            <div id="sq-expiration-date"></div>
                                        </div>
                                        <div class="sq-field sq-field--in-wrapper">
                                            <label class="sq-label text-white">Postal</label>
                                            <div id="sq-postal-code"></div>
                                        </div>
                                    </div>
                                    <div class="sq-field">
                                        <button id="sq-creditcard" class="btn btn-primary" style="min-width: 100%;" onclick="onGetCardNonce(event)">
                                            Pay @Model.CartTotal.ToString("c") Now
                                        </button>
                                    </div>
                                    <!--
                                      After a nonce is generated it will be assigned to this hidden input field.
                                    -->
                                    <div id="error"></div>
                                    <input type="hidden" id="card-nonce" name="nonce">
                                }
                            </div>
                        </div>
                        <!-- End Payment Form -->
                    </div>
                }
                else
                {
                    <div class="float-left w-50">
                        <hr class="mb-4 border-white">

                        <h4 class="mb-3">Payment</h4>

                        <p class="text-white">You must provide your name and email address before proceeding to payment.</p>
                    </div>
                }
            </div>
        </div>
    </div>

    <script type="text/javascript">
        const paymentForm = new SqPaymentForm({


            cardNumber: {
                elementId: 'cc-number',
                placeholder: 'Card Number'
            },
            cvv: {
                elementId: 'cc-cvv',
                placeholder: 'CVV'
            },
            expirationDate: {
                elementId: 'cc-expiration',
                placeholder: 'MM/YY'
            },
            postalCode: {
                elementId: 'zip',
                placeholder: 'Postal'
            },
            // SqPaymentForm callback functions
            callbacks: {
                cardNonceResponseReceived: function (errors, nonce, cardData) {


                    alert(`The generated nonce is:\n${nonce}`);
                }
            }
        });

        function onGetCardNonce(event) {
            paymentForm.requestCardNonce();
        }

    </script>
</div>

@if (ViewBag.Response != null && !string.IsNullOrWhiteSpace(ViewBag.Response))
{
    <div class="modal" id="responseModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content border-danger">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Response</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    @ViewBag.Response
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
}
<script type="text/javascript">
    $(window).on('load', function () {
        $('#responseModal').modal('show');
    });
</script>

